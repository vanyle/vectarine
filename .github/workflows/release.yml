name: ğŸ‰ Release

on:
    workflow_dispatch:
        inputs:
            tag:
                description: "Release tag"
                required: true
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+"

env:
    CARGO_TERM_COLOR: always

jobs:
    release_windows:
        name: ğŸ—ï¸ Build for Windows x86_64
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v6
              name: ğŸ“‚ Checkout
              with:
                # Need png for icon in exe
                lfs: true

            - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
              name: âš™ï¸ Setup Rust
              with:
                  target: x86_64-pc-windows-msvc
                  cache-all-crates: true
                  cache-workspace-crates: true

            - name: ğŸ’¾ Cache vcpkg folder
              id: cache-target-folder
              uses: actions/cache@v4
              with:
                path: |
                  target/vcpkg
                  target/x86_64-pc-windows-msvc/release/build
                  target/x86_64-pc-windows-msvc/release/deps
                  target/x86_64-pc-windows-msvc/release/incremental
                key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}

            - name: âš™ï¸ Install cargo-vcpkg 
              run: |
                cargo install cargo-vcpkg
                cd runtime && cargo vcpkg build

            - name: ğŸ—ï¸ Build runtime (windows)
              run: cargo build -p runtime --target=x86_64-pc-windows-msvc --release

            - name: ğŸ—ï¸ Build editor (windows)
              run: cargo build -p editor --target=x86_64-pc-windows-msvc --release
            
            - name: ğŸ“¦ Store windows executables
              uses: actions/upload-artifact@v5
              with:
                name: vecta-windows
                path: |
                  target/x86_64-pc-windows-msvc/release/vecta.exe
                  target/x86_64-pc-windows-msvc/release/runtime.exe

    release_linux:
        name: ğŸ—ï¸ Build for Linux x86_64
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v6
            name: ğŸ“‚ Checkout
            with:
              lfs: false

          - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
            name: âš™ï¸ Setup Rust
            with:
                target: x86_64-unknown-linux-gnu
                cache-all-crates: true
                cache-workspace-crates: true

          - name: âš™ï¸ Install dependencies
            run: sudo apt-get update && sudo apt-get install -y libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev libsdl2-gfx-dev libmp3lame-dev

          - name: ğŸ—ï¸ Build runtime (linux)
            run: cargo build -p runtime --target=x86_64-unknown-linux-gnu --release

          - name: ğŸ—ï¸ Build editor (linux)
            run: cargo build -p editor --target=x86_64-unknown-linux-gnu --release

          - name: ğŸ“¦ Store linux executables
            uses: actions/upload-artifact@v5
            with:
              name: vecta-linux
              path: |
                target/x86_64-unknown-linux-gnu/release/vecta
                target/x86_64-unknown-linux-gnu/release/runtime

    release_web:
        name: ğŸ—ï¸ Build for Emscripten
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              name: ğŸ“‚ Checkout
              with:
                # need png for manual
                lfs: true

            - name: âš™ï¸ Install Mise and mise.toml dependencies
              uses: jdx/mise-action@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  cache: true
                  version: 2025.10.9
            
            - uses: mymindstorm/setup-emsdk@v14
              name: ğŸ”‹ Set up Emscripten
              with:
                  actions-cache-folder: 'emsdk-cache'
                  version: '4.0.13'

            - name: ğŸ³ Set up Docker
              uses: docker/setup-docker-action@v4

            - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
              name: âš™ï¸ Setup Rust
              with:
                  target: wasm32-unknown-emscripten
                  cache-all-crates: true
                  cache-workspace-crates: true

            - name: ğŸ—ï¸ Build runtime (web)
              run: cargo build -p runtime --target=wasm32-unknown-emscripten --release

            - name: ğŸ“– Make PDF
              run: mise run pdfify-manual

            - name: ğŸ“¦ Store web and PDF
              uses: actions/upload-artifact@v5
              with:
                name: vecta-web-and-manual
                path: |
                  target/wasm32-unknown-emscripten/release/runtime.js
                  target/wasm32-unknown-emscripten/release/runtime.wasm
                  docs/user-manual.pdf
    release_macos:
        name: ğŸ—ï¸ Build for macOS aarch64
        runs-on: macos-latest
        steps:
          - uses: actions/checkout@v6
            name: ğŸ“‚ Checkout
            with:
              lfs: false

          - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
            name: âš™ï¸ Setup Rust
            with:
                target: aarch64-apple-darwin
                cache-all-crates: true
                cache-workspace-crates: true

          - name: ğŸ’¾ Cache vcpkg folder
            id: cache-target-folder
            uses: actions/cache@v4
            with:
              path: |
                target/vcpkg
                target/aarch64-apple-darwin/release/build
                target/aarch64-apple-darwin/release/deps
                target/aarch64-apple-darwin/release/incremental
              key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}

          - name: âš™ï¸ Install cargo-vcpkg 
            run: |
              cargo install cargo-vcpkg
              cd runtime && cargo vcpkg build

          - name: ğŸ—ï¸ Build runtime (macos)
            run: cargo build -p runtime --target=aarch64-apple-darwin --release

          - name: ğŸ—ï¸ Build editor (macos)
            run: cargo build -p editor --target=aarch64-apple-darwin --release

          - name: ğŸ“¦ Store macos executables
            uses: actions/upload-artifact@v5
            with:
              name: vecta-macos
              path: |
                target/aarch64-apple-darwin/release/vecta
                target/aarch64-apple-darwin/release/runtime

    bundle:
      name: ğŸ“¦ Bundle and release
      needs: [release_linux, release_windows, release_web, release_macos]
      runs-on: ubuntu-latest
      permissions: write-all
      steps:
      - uses: actions/checkout@v6
        name: ğŸ“‚ Checkout
        with:
          # Need to bundle the gallery which has LFS files
          lfs: true

      - name: âš™ï¸ Install uv
        uses: astral-sh/setup-uv@v7

      - name: â¬‡ï¸ Download the web artefacts
        uses: actions/download-artifact@v6
        with:
          name: vecta-web-and-manual

      - name: â¬‡ï¸ Download the linux artefacts
        uses: actions/download-artifact@v6
        with:
          name: vecta-linux

      - name: â¬‡ï¸ Download the windows artefacts
        uses: actions/download-artifact@v6
        with:
          name: vecta-windows

      - name: â¬‡ï¸ Download the macos artefacts
        uses: actions/download-artifact@v6
        with:
          name: vecta-macos

      - name: ğŸšš Move executables to their place
        run: |
          mkdir -p ./target/x86_64-unknown-linux-gnu/release
          mkdir -p ./target/wasm32-unknown-emscripten/release
          mkdir -p ./target/aarch64-apple-darwin/release
          mkdir -p ./target/x86_64-pc-windows-msvc/release

      - name: ğŸ“¦ Generate release files
        run: uv run scripts/release-engine.py

      - name: âœ¨ Create a GitHub Release
        uses: elgohr/Github-Release-Action@f5c6d2e30a99be3a10be071af9410f26872840bd
        # This can fail if the release already exists. Let's ignore that.
        continue-on-error: true
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
            # ref_name is the tag.
            # We just put the version number as the title, no need to add vectarine, it looks weird
            title: "${{ inputs.tag || github.ref_name }}"
            tag: "${{ inputs.tag || github.ref_name }}"

      - name: ğŸ“¦ Upload release files
        uses: AButler/upload-release-assets@v3.0
        with:
          files: "vectarine.*.zip"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: "${{ inputs.tag || github.ref_name }}"
