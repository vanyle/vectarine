name: ğŸ‰ Release

on:
    workflow_dispatch:
        inputs:
            tag:
                description: "Release tag"
                required: true
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+"

env:
    CARGO_TERM_COLOR: always

jobs:
    release_windows:
        name: ğŸ—ï¸ Build for Windows x86_64
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v6
              name: ğŸ“‚ Checkout

            - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
              name: âš™ï¸ Setup Rust
              with:
                  components: clippy, rustfmt
                  target: x86_64-pc-windows-msvc
                  cache-all-crates: true
                  cache-workspace-crates: true

            - name: âš™ï¸ Install cargo-vcpkg 
              run: |
                cargo install cargo-vcpkg
                cd runtime && cargo vcpkg build
            
            - name: ğŸ—ï¸ Build runtime (windows)
              run: cargo build -p runtime --target=x86_64-pc-windows-msvc --release

            - name: ğŸ—ï¸ Build editor (windows)
              run: cargo build -p editor --target=x86_64-pc-windows-msvc --release
            
            - name: ğŸ“¦ Store windows executables
              uses: actions/upload-artifact@v5
              with:
                name: vecta-windows
                path: |
                  target/x86_64-pc-windows-msvc/release/vecta.exe
                  target/x86_64-pc-windows-msvc/release/runtime.exe

    release_linux:
        name: ğŸ—ï¸ Build for Linux x86_64 and Emscripten
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              name: ğŸ“‚ Checkout

            - name: âš™ï¸ Install Mise and mise.toml dependencies
              uses: jdx/mise-action@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  cache: true
                  version: 2025.10.9
            
            - uses: mymindstorm/setup-emsdk@v14
              name: ğŸ”‹ Set up Emscripten
              with:
                  actions-cache-folder: 'emsdk-cache'
                  version: '4.0.13'

            - name: ğŸ³ Set up Docker
              uses: docker/setup-docker-action@v4

            - name: ğŸ“– Make PDF
              run: mise run pdfify-manual

            - name: âš™ï¸ Install SDL2 dependencies
              run: sudo apt-get update && sudo apt-get install -y libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev libsdl2-gfx-dev libmp3lame-dev

            - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
              name: âš™ï¸ Setup Rust
              with:
                  components: clippy, rustfmt
                  target: x86_64-unknown-linux-gnu, wasm32-unknown-emscripten
                  cache-all-crates: true
                  cache-workspace-crates: true

            - name: ğŸ—ï¸ Build runtime (web)
              run: cargo build -p runtime --target=wasm32-unknown-emscripten --release

            - name: ğŸ—ï¸ Build runtime (linux)
              run: cargo build -p runtime --target=x86_64-unknown-linux-gnu --release

            - name: ğŸ—ï¸ Build editor (linux)
              run: cargo build -p editor --target=x86_64-unknown-linux-gnu --release

            - name: ğŸ“¦ Store linux executables, web and PDF
              uses: actions/upload-artifact@v5
              with:
                name: vecta-linux-web-and-manual
                path: |
                  target/x86_64-unknown-linux-gnu/release/vecta
                  target/x86_64-unknown-linux-gnu/release/runtime
                  target/wasm32-unknown-emscripten/release/runtime.js
                  target/wasm32-unknown-emscripten/release/runtime.wasm
                  docs/user-manual.pdf

    bundle:
      name: ğŸ“¦ Bundle and release
      needs: [release_linux, release_windows]
      runs-on: ubuntu-latest
      permissions: write-all
      steps:
      - uses: actions/checkout@v6
        name: ğŸ“‚ Checkout

      - name: âš™ï¸ Install uv
        uses: astral-sh/setup-uv@v7

      - name: â¬‡ï¸ Download the linux artefact
        uses: actions/download-artifact@v6
        with:
          name: vecta-linux-web-and-manual

      - name: â¬‡ï¸ Download the windows artefact
        uses: actions/download-artifact@v6
        with:
          name: vecta-windows

      - name: ğŸšš Move executables to their place
        run: |
          mkdir -p ./target/x86_64-unknown-linux-gnu/release
          mkdir -p ./target/wasm32-unknown-emscripten/release
          mkdir -p ./target/aarch64-apple-darwin/release
          mkdir -p ./target/x86_64-pc-windows-msvc/release

      - name: ğŸ“¦ Generate release files
        run: uv run scripts/release-engine.py

      - name: âœ¨ Create a GitHub Release
        uses: elgohr/Github-Release-Action@f5c6d2e30a99be3a10be071af9410f26872840bd
        # This can fail if the release already exists. Let's ignore that.
        continue-on-error: true
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
            # ref_name is the tag.
            title: "Vectarine ${{ inputs.tag || github.ref_name }}"
            tag: "${{ inputs.tag || github.ref_name }}"

      - name: ğŸ“¦ Upload release files
        uses: AButler/upload-release-assets@v3.0
        with:
          files: "vectarine.zip"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: "${{ inputs.tag || github.ref_name }}"
