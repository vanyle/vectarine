name: ğŸ‰ Release

on:
    workflow_dispatch:
        inputs:
            tag:
                description: "Release tag"
                required: true
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+"

env:
    CARGO_TERM_COLOR: always

jobs:
    release_windows:
        name: ğŸ—ï¸ Build for Windows x86_64
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v6
              name: ğŸ“‚ Checkout
              with:
                # Need png for icon in exe
                lfs: true

            - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
              name: âš™ï¸ Setup Rust
              with:
                  target: x86_64-pc-windows-msvc
                  cache-all-crates: true
                  cache-workspace-crates: true

            - name: ğŸ’¾ Cache vcpkg folder
              id: cache-target-folder
              uses: actions/cache@v4
              with:
                path: |
                  target/vcpkg
                  target/x86_64-pc-windows-msvc/release/build
                  target/x86_64-pc-windows-msvc/release/deps
                  target/x86_64-pc-windows-msvc/release/incremental
                key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}

            - name: âš™ï¸ Install cargo-vcpkg 
              run: |
                cargo install cargo-vcpkg
                cd runtime && cargo vcpkg build

            - name: ğŸ—ï¸ Build runtime (windows)
              run: cargo build -p runtime --target=x86_64-pc-windows-msvc --release

            - name: ğŸ—ï¸ Build editor (windows)
              run: cargo build -p editor --target=x86_64-pc-windows-msvc --release
            
            - name: ğŸ“¦ Store windows executables
              uses: actions/upload-artifact@v5
              with:
                name: vecta-windows
                retention-days: 1
                path: |
                  target/x86_64-pc-windows-msvc/release/vecta.exe
                  target/x86_64-pc-windows-msvc/release/runtime.exe

    release_linux:
        name: ğŸ—ï¸ Build for Linux x86_64
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v6
            name: ğŸ“‚ Checkout
            with:
              lfs: true

          - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
            name: âš™ï¸ Setup Rust
            with:
                target: x86_64-unknown-linux-gnu
                cache-all-crates: false
                cache-workspace-crates: false

          - name: âš™ï¸ Install dependencies
            run: sudo apt-get update && sudo apt-get install -y libsdl2-dev libmp3lame-dev libjack-dev libpipewire-0.3-dev

          - name: ğŸ—ï¸ Build runtime (linux)
            run: cargo build -p runtime --target=x86_64-unknown-linux-gnu --release

          - name: ğŸ—ï¸ Build editor (linux)
            run: cargo build -p editor --target=x86_64-unknown-linux-gnu --release

          - name: ğŸ“¦ Store linux executables
            uses: actions/upload-artifact@v5
            with:
              name: vecta-linux
              retention-days: 1
              path: |
                target/x86_64-unknown-linux-gnu/release/vecta
                target/x86_64-unknown-linux-gnu/release/runtime

    release_web:
        name: ğŸ—ï¸ Build for Emscripten
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              name: ğŸ“‚ Checkout
              with:
                # need png for manual
                lfs: true

            - name: âš™ï¸ Install Mise and mise.toml dependencies
              uses: jdx/mise-action@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  cache: true
                  version: 2025.10.9
            
            - uses: mymindstorm/setup-emsdk@v14
              name: ğŸ”‹ Set up Emscripten
              with:
                  actions-cache-folder: 'emsdk-cache'
                  version: '4.0.13'

            - name: ğŸ³ Set up Docker
              uses: docker/setup-docker-action@v4

            - name: ğŸ’¾ Cache target folder
              id: cache-target-folder
              uses: actions/cache@v4
              with:
                path: |
                  target/wasm32-unknown-emscripten/release/build
                  target/wasm32-unknown-emscripten/release/deps
                  target/wasm32-unknown-emscripten/release/incremental
                key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}

            - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
              name: âš™ï¸ Setup Rust
              with:
                  target: wasm32-unknown-emscripten
                  cache-all-crates: true
                  cache-workspace-crates: true

            - name: ğŸ—ï¸ Build runtime (web)
              run: cargo build -p runtime --target=wasm32-unknown-emscripten --release

            - name: ğŸ“– Make PDF
              run: mise run pdfify-manual

            - name: ğŸ“¦ Store web and PDF
              uses: actions/upload-artifact@v5
              with:
                name: vecta-web-and-manual
                retention-days: 1
                path: |
                  target/wasm32-unknown-emscripten/release/runtime.js
                  target/wasm32-unknown-emscripten/release/runtime.wasm
                  docs/user-manual.pdf
    release_macos:
        name: ğŸ—ï¸ Build for macOS aarch64
        runs-on: macos-latest
        steps:
          - uses: actions/checkout@v6
            name: ğŸ“‚ Checkout
            with:
              lfs: true

          - uses: actions-rust-lang/setup-rust-toolchain@ca4a6432af353637602348dec3df861ef02ed8a6
            name: âš™ï¸ Setup Rust
            with:
                target: aarch64-apple-darwin
                cache-all-crates: true
                cache-workspace-crates: true

          - name: ğŸ’¾ Cache vcpkg folder
            id: cache-target-folder
            uses: actions/cache@v4
            with:
              path: |
                target/vcpkg
                target/aarch64-apple-darwin/release/build
                target/aarch64-apple-darwin/release/deps
                target/aarch64-apple-darwin/release/incremental
              key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}

          - name: âš™ï¸ Install cargo-vcpkg 
            run: |
              cargo install cargo-vcpkg
              cd runtime && cargo vcpkg build

          - name: ğŸ—ï¸ Build runtime (macos)
            run: cargo build -p runtime --target=aarch64-apple-darwin --release

          - name: ğŸ—ï¸ Build editor (macos)
            run: cargo build -p editor --target=aarch64-apple-darwin --release

          - name: ğŸ“¦ Store macos executables
            uses: actions/upload-artifact@v5
            with:
              name: vecta-macos
              retention-days: 1
              path: |
                target/aarch64-apple-darwin/release/vecta
                target/aarch64-apple-darwin/release/runtime

    bundle:
      name: ğŸ“¦ Bundle and release
      needs: [release_linux, release_windows, release_web, release_macos]
      runs-on: ubuntu-latest
      permissions:
        contents: write
      steps:
      - uses: actions/checkout@v6
        name: ğŸ“‚ Checkout
        with:
          # Need to bundle the gallery which has LFS files
          lfs: true

      - name: âš™ï¸ Install uv
        uses: astral-sh/setup-uv@v7

      - name: â¬‡ï¸ Download Linux artefacts
        uses: actions/download-artifact@v6
        with:
          path: ./linux
          pattern: vecta-linux
        continue-on-error: true

      - name: â¬‡ï¸ Download Windows artefacts
        uses: actions/download-artifact@v6
        with:
          path: ./windows
          pattern: vecta-windows
        continue-on-error: true

      - name: â¬‡ï¸ Download Web artefacts
        uses: actions/download-artifact@v6
        with:
          path: ./web
          pattern: vecta-web-and-manual
        continue-on-error: true

      - name: â¬‡ï¸ Download macOS artefacts
        uses: actions/download-artifact@v6
        with:
          path: ./macos
          pattern: vecta-macos
        continue-on-error: true

      - name: ğŸšš Move the artefacts
        # For some reason, the web artefacts are inside /target/wasm32-unknown-emscripten/release but not the others.
        run: |
          mkdir -p ./target/x86_64-unknown-linux-gnu/release
          mkdir -p ./target/x86_64-pc-windows-msvc/release
          mkdir -p ./target/aarch64-apple-darwin/release
          mkdir -p ./target/wasm32-unknown-emscripten/release
          mkdir -p ./docs
          ls -R ./linux
          ls -R ./windows
          ls -R ./macos
          ls -R ./web
          mv -f ./linux/* ./target/x86_64-unknown-linux-gnu/release/
          mv -f ./windows/* ./target/x86_64-pc-windows-msvc/release/
          mv -f ./macos/* ./target/aarch64-apple-darwin/release/
          mv -f ./web/docs/* ./docs/
          mv -f ./web/target/wasm32-unknown-emscripten/release/* ./target/wasm32-unknown-emscripten/release/
        continue-on-error: true

      - name: ğŸ“¦ Generate release files
        run: uv run scripts/release-engine.py

      - name: âœ¨ Create a GitHub Release
        uses: softprops/action-gh-release@v2
        # This can fail if the release already exists. Let's ignore that.
        continue-on-error: true
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
            # ref_name is the tag.
            # We just put the version number as the title, no need to add vectarine, it looks weird 
            name: "${{ inputs.tag || github.ref_name }}"
            tag_name: "${{ inputs.tag || github.ref_name }}"
            # Note: we could use a script to generate a body someday.
            body: ""

      - name: ğŸ“¦ Upload release files
        uses: AButler/upload-release-assets@v3.0
        with:
          files: "vectarine.*.zip"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          release-tag: "${{ inputs.tag || github.ref_name }}"
